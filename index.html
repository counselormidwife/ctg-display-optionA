<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CTG / TOCO / IUPC Display â€“ Option A (Large Text)</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #0b0f14;
    overflow: hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Canvas */
canvas {
    position: absolute;
    inset: 0;
}

/* HUD */
#hud {
    position: absolute;
    top: 16px;
    left: 16px;
    padding: 14px 18px;
    border-radius: 14px;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(6px);
    color: #ffffff;
    font-size: 20px;            /* ðŸ”¹ increased */
    line-height: 1.4;
    min-width: 280px;
}

#hud b {
    font-weight: 700;
}

.dim {
    opacity: 0.8;
    font-size: 18px;
}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div id="hud">
    <div><b>Mode:</b> <span id="mode">TOCO</span> <span class="dim" id="submode">(grid)</span></div>
    <div><b>Patient:</b> <span id="patient">â€”</span> <span class="dim" id="ga"></span></div>
    <div><b>FHR:</b> <span id="fhr">â€”</span></div>
    <div><b>UC:</b> <span id="uc">TOCO 0%</span></div>
</div>

<script>
/* ============================================================
   Core setup
============================================================ */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = innerWidth * dpr;
    canvas.height = innerHeight * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* ============================================================
   State
============================================================ */
const state = {
    mode: "TOCO",
    running: false,
    x: 0,
    step: 2,
    fhrBuf: [[],[],[]],
    ucBuf: [],
    fhr: {},
    uc: { toco: 0, mmhg: null, tone: null }
};

const ui = {
    mode: document.getElementById("mode"),
    sub: document.getElementById("submode"),
    patient: document.getElementById("patient"),
    ga: document.getElementById("ga"),
    fhr: document.getElementById("fhr"),
    uc: document.getElementById("uc")
};

/* ============================================================
   Mapping helpers
============================================================ */
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

function fhrY(bpm, mid){
    const lo=30, hi=240;
    const t=(clamp(bpm,lo,hi)-lo)/(hi-lo);
    return (mid-30)-(mid-60)*t;
}

function ucY(v, mid, h){
    const t=clamp(v,0,100)/100;
    return (h-30)-(h-mid-60)*t;
}

/* ============================================================
   Drawing
============================================================ */
function drawGrid(){
    const w=innerWidth, h=innerHeight;
    const mid=Math.floor(h*0.68);

    ctx.fillStyle="#0b0f14";
    ctx.fillRect(0,0,w,h);

    ctx.lineWidth=1;
    for(let x=0;x<w;x+=20){
        ctx.strokeStyle=(x%100===0)?"rgba(255,255,255,0.12)":"rgba(255,255,255,0.05)";
        ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
    }
    for(let y=0;y<h;y+=20){
        ctx.strokeStyle=(y%100===0)?"rgba(255,255,255,0.12)":"rgba(255,255,255,0.05)";
        ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
    }

    ctx.lineWidth=3;
    ctx.strokeStyle="rgba(255,255,255,0.35)";
    ctx.beginPath();ctx.moveTo(0,mid);ctx.lineTo(w,mid);ctx.stroke();

    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.font="18px system-ui";   /* ðŸ”¹ larger axis labels */

    [60,90,120,150,180].forEach(v=>{
        ctx.fillText(v,10,fhrY(v,mid));
    });

    if(state.mode==="IUPC"){
        [10,20,30,40,50,60].forEach(v=>{
            ctx.fillText(v,10,ucY(v,mid,h));
        });
    }
}

function drawTrace(buf,color){
    if(buf.length<2) return;
    ctx.strokeStyle=color;
    ctx.lineWidth=3;             /* ðŸ”¹ thicker lines */
    ctx.beginPath();
    ctx.moveTo(buf[0].x,buf[0].y);
    for(let i=1;i<buf.length;i++) ctx.lineTo(buf[i].x,buf[i].y);
    ctx.stroke();
}

function scroll(){
    if(state.x<=innerWidth) return;
    state.fhrBuf.forEach((b,i)=>{
        state.fhrBuf[i]=b.map(p=>({x:p.x-state.step,y:p.y})).filter(p=>p.x>=0);
    });
    state.ucBuf=state.ucBuf.map(p=>({x:p.x-state.step,y:p.y})).filter(p=>p.x>=0);
    state.x-=state.step;
}

function render(){
    drawGrid();
    drawTrace(state.fhrBuf[0],"#00ff9c");
    drawTrace(state.fhrBuf[1],"#ffd000");
    drawTrace(state.fhrBuf[2],"#7ab8ff");
    drawTrace(state.ucBuf,"#ff5c7a");
    requestAnimationFrame(render);
}
render();

/* ============================================================
   Message handling (SL bridge)
============================================================ */
function reset(){
    state.x=0;
    state.fhrBuf=[[],[],[]];
    state.ucBuf=[];
}

function updateHUD(){
    const f=[];
    for(const i in state.fhr) f.push(`B${+i+1}:${state.fhr[i]}`);
    ui.fhr.textContent=f.length?f.join("  "):"â€”";
    ui.uc.textContent=state.mode==="TOCO"
        ?`TOCO ${Math.round(state.uc.toco)}%`
        :`IUPC ${state.uc.mmhg??"â€”"} mmHg`;
}

function parse(msg){
    const p=msg.split("|");
    if(p[0]==="DISP" && p[1]==="RESET"){ reset(); return; }
    if(p[0]==="DISP" && p[1]==="MODE"){
        state.mode=p[2]==="IUPC"?"IUPC":"TOCO";
        ui.mode.textContent=state.mode;
        ui.sub.textContent=state.mode==="IUPC"?"(mmHg)":"(grid)";
        reset();
        return;
    }
    if(p[0]==="MC" && p[1]==="PATIENT"){
        ui.patient.textContent=p[2]||"â€”";
        ui.ga.textContent=p[3]?`${p[3]}w`:"";
        return;
    }
    if(p[0]==="FHR"){
        const idx=+p[2], bpm=+p[3];
        if(!isNaN(bpm)){
            state.fhr[idx]=Math.round(bpm);
            state.fhrBuf[idx].push({x:state.x,y:fhrY(bpm,innerHeight*0.68)});
            state.x+=state.step; scroll(); updateHUD();
        }
    }
    if(p[0]==="CON"){
        if(p[1]==="TOCO"){
            state.uc.toco=+p[2];
            if(state.mode==="TOCO"){
                state.ucBuf.push({x:state.x,y:ucY(state.uc.toco,innerHeight*0.68,innerHeight)});
            }
        }
        if(p[1]==="IUPC"){
            state.uc.mmhg=+p[2];
            if(state.mode==="IUPC"){
                state.ucBuf.push({x:state.x,y:ucY(state.uc.mmhg,innerHeight*0.68,innerHeight)});
            }
        }
        state.x+=state.step; scroll(); updateHUD();
    }
}

window.SLReceiveEncoded=e=>{
    try{ parse(decodeURIComponent(e)); }catch{}
};
</script>
</body>
</html>
