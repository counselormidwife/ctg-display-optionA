<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTG / NST Display</title>
<style>
    body {
        margin: 0;
        background: #111;
        color: #eee;
        font-family: Arial, Helvetica, sans-serif;
        overflow: hidden;
    }

    #header {
        padding: 6px 10px;
        background: #1c1c1c;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #status {
        font-weight: bold;
    }

    #nst {
        font-size: 13px;
    }

    canvas {
        display: block;
        background: #000;
    }

    #fhrCanvas {
        height: 260px;
    }

    #ucCanvas {
        height: 140px;
        border-top: 1px solid #333;
    }
</style>
</head>

<body>

<div id="header">
    <div id="status">MODE</div>
    <div id="nst">NST</div>
</div>

<canvas id="fhrCanvas"></canvas>
<canvas id="ucCanvas"></canvas>

<script>
/* -------------------- PARAM PARSING -------------------- */

const params = new URLSearchParams(window.location.search);

function getList(name) {
    const raw = params.get(name);
    if (!raw) return [];
    return raw.split(",").map(v => parseInt(v, 10));
}

function getMarkers() {
    const raw = params.get("k");
    if (!raw) return [];
    return raw.split(";").map(m => {
        const p = m.split(":");
        return { t: parseInt(p[0]), code: p[1], sub: p[2] || "" };
    });
}

/* -------------------- DATA -------------------- */

const mode       = params.get("mode") || "IDLE";
const patient    = params.get("pat")  || "";
const ga         = params.get("ga")   || "";
const fhr        = getList("f");
const uc         = getList("u");
const markers    = getMarkers();

const nstStatus  = params.get("nst") || "";
const elapsed    = parseInt(params.get("e") || 0);
const total      = parseInt(params.get("T") || 0);

/* -------------------- HEADER -------------------- */

document.getElementById("status").innerText =
    `${mode}  |  ${patient} ${ga}w`;

if (mode === "NST") {
    document.getElementById("nst").innerText =
        `NST: ${nstStatus}  ${elapsed}/${total}s`;
} else {
    document.getElementById("nst").innerText = "";
}

/* -------------------- CANVAS SETUP -------------------- */

const fhrCanvas = document.getElementById("fhrCanvas");
const ucCanvas  = document.getElementById("ucCanvas");

fhrCanvas.width = window.innerWidth;
ucCanvas.width  = window.innerWidth;

fhrCanvas.height = 260;
ucCanvas.height  = 140;

const fctx = fhrCanvas.getContext("2d");
const uctx = ucCanvas.getContext("2d");

/* -------------------- DRAW HELPERS -------------------- */

function drawGrid(ctx, h, vStep, hStep) {
    ctx.strokeStyle = "#222";
    ctx.lineWidth = 1;

    for (let y = 0; y < h; y += hStep) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(ctx.canvas.width, y);
        ctx.stroke();
    }

    for (let x = 0; x < ctx.canvas.width; x += vStep) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
    }
}

function drawWave(ctx, data, min, max, color) {
    if (!data.length) return;

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();

    const scaleY = ctx.canvas.height / (max - min);
    const stepX = ctx.canvas.width / (data.length - 1);

    data.forEach((v, i) => {
        const x = i * stepX;
        const y = ctx.canvas.height - ((v - min) * scaleY);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.stroke();
}

function drawMarkers(ctx, markers, y) {
    markers.forEach(m => {
        let color = "#888";
        if (m.code === "M") color = "#4af";     // movement
        if (m.code === "A") color = "#5f5";     // accel
        if (m.code === "DE" || m.code === "DL" || m.code === "DV") color = "#f55";

        ctx.fillStyle = color;
        ctx.fillRect(
            (m.t / (fhr.length || 1)) * ctx.canvas.width,
            y,
            2,
            12
        );
    });
}

/* -------------------- DRAW -------------------- */

fctx.clearRect(0, 0, fhrCanvas.width, fhrCanvas.height);
uctx.clearRect(0, 0, ucCanvas.width, ucCanvas.height);

// grids
drawGrid(fctx, fhrCanvas.height, 60, 40);
drawGrid(uctx, ucCanvas.height, 60, 35);

// waves
drawWave(fctx, fhr, 60, 200, "#0f0");
drawWave(uctx, uc, 0, 100, "#fff");

// markers
drawMarkers(fctx, markers, 10);
drawMarkers(uctx, markers, 10);
</script>

</body>
</html>
