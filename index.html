<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTG / NST Display</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
}

/* Header */
#header {
    position: absolute;
    top: 6px;
    left: 10px;
    z-index: 10;
    font-size: 16px;
    font-weight: bold;
    color: #ffffff;
    text-shadow: 0 0 4px #000;
}

#subheader {
    position: absolute;
    top: 30px;
    left: 10px;
    z-index: 10;
    font-size: 14px;
    color: #aaffaa;
    text-shadow: 0 0 4px #000;
}

/* Layout container */
#container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
}

/* Canvases */
canvas {
    display: block;
    width: 100%;
}

#fhrCanvas {
    flex: 7;               /* ~70% */
    background: #000;
}

#ucCanvas {
    flex: 3;               /* ~30% */
    background: #000;
    border-top: 2px solid #444;
}
</style>
</head>

<body>

<div id="header">CTG MONITOR</div>
<div id="subheader">â€”</div>

<div id="container">
    <canvas id="fhrCanvas"></canvas>
    <canvas id="ucCanvas"></canvas>
</div>

<script>
/* ---------- URL PARAMS ---------- */

const params = new URLSearchParams(window.location.search);

function list(name) {
    const v = params.get(name);
    return v ? v.split(",").map(n => parseInt(n, 10)) : [];
}

function markers() {
    const raw = params.get("k");
    if (!raw) return [];
    return raw.split(";").map(m => {
        const p = m.split(":");
        return { t: +p[0], code: p[1] };
    });
}

const mode    = params.get("mode") || "IDLE";
const patient = params.get("pat") || "";
const ga      = params.get("ga")  || "";

const fhr = list("f");
const uc  = list("u");
const mk  = markers();

const nst = params.get("nst") || "";
const e   = +params.get("e") || 0;
const T   = +params.get("T") || 0;

/* ---------- HEADER ---------- */

document.getElementById("header").innerText =
    `${mode}  |  ${patient} ${ga}w`;

document.getElementById("subheader").innerText =
    mode === "NST" ? `NST: ${nst}   ${e}/${T}s` : "";

/* ---------- CANVAS SETUP ---------- */

const fhrC = document.getElementById("fhrCanvas");
const ucC  = document.getElementById("ucCanvas");

function resizeCanvases() {
    fhrC.width = window.innerWidth;
    ucC.width  = window.innerWidth;

    fhrC.height = fhrC.clientHeight;
    ucC.height  = ucC.clientHeight;
}

window.addEventListener("resize", resizeCanvases);
resizeCanvases();

const fctx = fhrC.getContext("2d");
const uctx = ucC.getContext("2d");

/* ---------- DRAW HELPERS ---------- */

function grid(ctx, min, max, step, labelEvery) {
    const h = ctx.canvas.height;
    const scale = h / (max - min);

    ctx.strokeStyle = "#555";
    ctx.lineWidth = 1.5;
    ctx.fillStyle = "#ddd";
    ctx.font = "12px Arial";

    for (let v = min; v <= max; v += step) {
        const y = h - (v - min) * scale;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(ctx.canvas.width, y);
        ctx.stroke();

        if (v % labelEvery === 0) {
            ctx.fillText(v.toString(), 6, y - 2);
        }
    }
}

function wave(ctx, data, min, max, color) {
    if (!data.length) return;

    const h = ctx.canvas.height;
    const scaleY = h / (max - min);
    const stepX = ctx.canvas.width / (data.length - 1);

    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5;
    ctx.beginPath();

    data.forEach((v, i) => {
        const x = i * stepX;
        const y = h - (v - min) * scaleY;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });

    ctx.stroke();
}

function drawMarkers(ctx, mks, y) {
    mks.forEach(m => {
        let c = "#888";
        if (m.code === "M") c = "#4aa3ff";
        if (m.code === "A") c = "#66ff66";
        if (m.code === "DE" || m.code === "DL" || m.code === "DV") c = "#ff5555";

        ctx.fillStyle = c;
        ctx.fillRect(
            (m.t / (fhr.length || 1)) * ctx.canvas.width,
            y,
            3,
            16
        );
    });
}

/* ---------- DRAW ---------- */

fctx.clearRect(0, 0, fhrC.width, fhrC.height);
uctx.clearRect(0, 0, ucC.width, ucC.height);

// grids
grid(fctx, 60, 200, 10, 20);
grid(uctx, 0, 100, 10, 20);

// waves
wave(fctx, fhr, 60, 200, "#00ff00");
wave(uctx, uc, 0, 100, "#ffffff");

// markers
drawMarkers(fctx, mk, 10);
drawMarkers(uctx, mk, 10);
</script>

</body>
</html>
